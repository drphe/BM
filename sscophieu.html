<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="32x32" href="https://fmarket.vn/favicon.ico">
    <title>So sánh hiệu suất các cổ phiếu trong ngành</title>
    <link rel="stylesheet" type="text/css" href="loading.css">
    <style>
        * {
            font-family: Roboto, Helvetica, Arial, sans-serif;
            margin: 0px;
        }

        body {
            background-color: white;
        }

        #app {
            max-width: 100%;
            max-height: calc(100vh - 100px);
            overflow: scroll;
        }

        /* CSS cho popup */
        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0);
            /* Bắt đầu với kích thước 0 */
            border: 2px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background-color: #fff;
            z-index: 1000;
            transition: transform 0.3s ease, opacity 0.3s ease;
            /* Thêm hiệu ứng cho transform và opacity */
            opacity: 0;
            /* Bắt đầu với độ mờ */
        }

        /* Khi popup được hiển thị */
        .popup.show {
            display: block;
            transform: translate(-50%, -50%) scale(1);
            /* Phóng lên đến kích thước ban đầu */
            opacity: 1;
            /* Đảm bảo popup có độ mờ là 1 */
        }

        .popup table {
            width: 400px;
            border-collapse: collapse;
            font-size: 12px;
        }

        .popup table,
        .popup th,
        .popup td {
            border: 1px solid #000;
            width: max-content;
        }

        .popup th,
        .popup td {
            padding: 8px;
            text-align: left;
        }

        .popup-close {
            cursor: pointer;
            color: red;
            float: right;
            font-size: 20px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            /* Màu nền mờ */
            backdrop-filter: blur(5px);
            /* Hiệu ứng mờ nền */
            z-index: 999;
            display: none;
            /* Ẩn khi chưa mở popup */
        }

        /* Style cho các nút */
        .button-container {
            margin: 10px;
        }

        .button-container button {
            padding: 5px 10px;
            margin-right: 10px;
            cursor: pointer;
            border: 2px solid #007bff;
            /* Đặt viền cho nút */
            background-color: #007bff;
            /* Màu nền nút */
            color: white;
            /* Màu chữ */
            font-size: 14px;
            /* Kích thước chữ */
            border-radius: 5px;
            /* Bo góc cho nút */
            transition: all 0.3s ease;
            /* Hiệu ứng chuyển tiếp */
        }

        /* Hiệu ứng khi người dùng di chuột vào nút */
        .button-container button:hover {
            background-color: #0056b3;
            /* Màu nền thay đổi khi hover */
            transform: scale(1.1);
            /* Phóng to nút khi di chuột vào */
        }

        /* Hiệu ứng khi nút được nhấn */
        .button-container button:active {
            background-color: #003f7f;
            /* Màu nền khi nút bị nhấn */
            transform: scale(0.98);
            /* Thu nhỏ nút khi nhấn */
        }

        /* Thêm hiệu ứng khi nút bị vô hiệu hóa */
        .button-container button:disabled {
            background-color: #ccc;
            /* Màu nền cho nút vô hiệu hóa */
            cursor: not-allowed;
            /* Thay đổi con trỏ khi nút vô hiệu hóa */
        }
    </style>
</head>

<body>
    <div id="load"></div>
    <div id="app">
        <div class="button-container">
            <button onclick="checkSection()">Ngành ngân hàng</button>
            <button onclick="checkSection('thep')">Ngành thép</button>
            <button onclick="checkSection('banle')">Ngành bán lẻ</button>
            <button onclick="checkSection('5')">Ngành 5</button>
        </div>

    </div>
    <div id="overlay" class="overlay"></div>
    <script>
        function loading(i = !0) {
            document.getElementById("load").innerHTML = i ? `<div class="loading-container"><div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>` : ""
        }
        const overlay = document.getElementById("overlay");
        // Hàm lấy ngày hiện tại theo định dạng yyyy-mm-dd
        function getCurrentDate() {
            const t = new Date();
            return t.getFullYear() + "-" + String(t.getMonth() + 1)
                .padStart(2, "0") + "-" + String(t.getDate())
                .padStart(2, "0");
        }

        function unixToDate(timestamp) {
            // Tạo đối tượng Date từ Unix timestamp (timestamp là số giây)
            let date = new Date(timestamp * 1000); // Nhân với 1000 để chuyển đổi từ giây thành millisecond

            // Lấy các thành phần năm, tháng, ngày
            let year = date.getFullYear();
            let month = (date.getMonth() + 1).toString().padStart(2, '0'); // Tháng bắt đầu từ 0 nên cần cộng 1
            let day = date.getDate().toString().padStart(2, '0');

            // Trả về chuỗi theo định dạng yyyy-mm-dd
            return `${year}-${month}-${day}`;
        }

        var mainData = {};
        async function getData(symbol) {
            try {
                const url = 'https://mastrade.masvn.com/api/v1/tradingview/history?symbol=' + symbol + '&resolution=1D&from=' + parseInt(Date.parse("2015-01-01") / 1000) + '&to=' + parseInt(Date.parse(getCurrentDate()) / 1000);
                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error('Lỗi khi tải dữ liệu: ' + res.statusText);
                }
                const data = await res.json();
                // Chuyển đổi sang định dạng mong muốn
                const transformedData = data.t.map((timestamp, index) => ({
                    id: index + 1, // Tạo ID tự động tăng dần
                    createdAt: data.t[index] * 1000, // thời gian
                    nav: data.c[index], // Giá đóng cửa
                }));
                symbol = symbol == "VN-INDEX" ? "VNINDEX" : symbol;
                mainData[symbol] = calculatePerformance(transformedData);
            } catch (error) {
                console.error('Có lỗi xảy ra:', error);
            }
        }

        function calculatePerformance(NavData) {
            // Chuyển đổi thời gian thành ngày (tính theo ngày)
            const msInDay = 1000 * 60 * 60 * 24;
            const msInMonth = 1000 * 60 * 60 * 24 * 15; // 1/2 tháng = 15 ngày

            // Tính CAGR (Tỷ suất lợi nhuận hàng năm)
            const calculateCAGR = (startNav, endNav, years) => {
                return Math.pow(endNav / startNav, 1 / years) - 1;
            };

            // Tính độ lệch chuẩn
            const calculateStandardDeviation = (values) => {
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                return Math.sqrt(variance);
            };

            // Tính độ lệch chuẩn phần trăm
            const calculateCVPercent = (stdDev, mean) => {
                return (stdDev / mean) * 100;
            };
            // Lấy giá trị NAV đầu năm (từ ngày 1 tháng 1 của năm hiện tại)
            const getNavForYearStart = () => {
                const startOfYear = new Date(new Date().getFullYear(), 0, 1).getTime();
                const startNav = NavData.find(item => item.createdAt >= startOfYear);
                if (!startNav) return null; // Không tìm thấy dữ liệu đầu năm
                return startNav.nav;
            };
            // Tìm giá trị NAV đầu kỳ gần nhất với periodStartDate (không cách quá 1 tháng)
            const getNavForPeriod = (days) => {
                const periodStartDate = Date.now() - (days * msInDay);
                // Lọc tất cả các item có createdAt lớn hơn hoặc bằng periodStartDate
                const validNavData = NavData.filter(item => item.createdAt >= periodStartDate);

                // Nếu không có dữ liệu nào thỏa mãn, trả về null
                if (validNavData.length === 0) return null;

                // Tìm giá trị NAV gần nhất với periodStartDate
                const startNav = validNavData.reduce((prev, curr) => {
                    // Nếu khoảng cách giữa current.nav và periodStartDate > 1 tháng (30 ngày), thì bỏ qua
                    if (Math.abs(curr.createdAt - periodStartDate) > msInMonth) {
                        return prev; // Giữ lại phần tử trước đó
                    }
                    return (Math.abs(curr.createdAt - periodStartDate) < Math.abs(prev.createdAt - periodStartDate)) ? curr : prev;
                });

                // Nếu giá trị gần nhất cách quá 1 tháng, trả về null
                if (Math.abs(startNav.createdAt - periodStartDate) > msInMonth) {
                    return null;
                }

                return startNav.nav;
            };

            // Kiểm tra xem có đủ dữ liệu trong khoảng thời gian yêu cầu không
            const isDataSufficientForPeriod = (periodInDays) => {
                const periodStartDate = Date.now() - (periodInDays * msInDay);
                const dataInPeriod = NavData.filter(item => item.createdAt >= periodStartDate);
                return dataInPeriod.length > 1; // Kiểm tra có ít nhất 2 giá trị NAV trong khoảng thời gian
            };

            // Tính CAGR và độ lệch chuẩn theo phần trăm cho 1 năm, 3 năm, 5 năm
            let returns = {};
            let periods = [365, 3 * 365, 5 * 365]; // 1 năm = 365 ngày, 3 năm = 3*365 ngày, 5 năm = 5*365 ngày
            periods.forEach(periodInDays => {
                if (isDataSufficientForPeriod(periodInDays)) {
                    const startNav = getNavForPeriod(periodInDays);
                    const latestNav = NavData[NavData.length - 1].nav; // NAV hiện tại (mới nhất)
                    if (!startNav) {
                        returns[periodInDays / 365] = {
                            cagr: 0,
                            std: 0
                        }; // Không đủ dữ liệu
                        return;
                    }
                    const years = periodInDays / 365; // Số năm tương ứng
                    const cagr = calculateCAGR(startNav, latestNav, years);
                    const navValues = NavData.filter(item => item.createdAt >= (Date.now() - (periodInDays * msInDay))).map(item => item.nav);
                    const stdDev = calculateStandardDeviation(navValues);
                    const cvPercent = calculateCVPercent(stdDev, navValues.reduce((a, b) => a + b, 0) / navValues.length); // Tính độ lệch chuẩn phần trăm

                    returns[years] = {
                        cagr: cagr * 100, // Tỷ suất lợi nhuận theo năm, chuyển sang phần trăm
                        std: cvPercent
                    };
                } else {
                    const years = periodInDays / 365;
                    returns[years] = {
                        cagr: 0,
                        std: 0
                    };
                }
            });

            // Tính lợi suất từ đầu năm (YTD%) và biến động YTD
            const startOfYearNav = getNavForYearStart();
            if (startOfYearNav) {
                const latestNav = NavData[NavData.length - 1].nav; // NAV hiện tại
                const ytdReturn = ((latestNav - startOfYearNav) / startOfYearNav) * 100; // Tính YTD% 

                // Lọc dữ liệu NAV từ đầu năm tới hiện tại
                const navValuesYTD = NavData.filter(item => item.createdAt >= new Date(new Date().getFullYear(), 0, 1).getTime()).map(item => item.nav);
                const stdDevYTD = calculateStandardDeviation(navValuesYTD);
                const cvPercentYTD = calculateCVPercent(stdDevYTD, navValuesYTD.reduce((a, b) => a + b, 0) / navValuesYTD.length); // Tính độ lệch chuẩn YTD phần trăm

                returns.ytd = {
                    cagr: ytdReturn,
                    std: cvPercentYTD
                };
            }

            return returns;
        }


        async function fetchSequentiallyData(data) {
            for (const s of data) {
                try {
                    const result = await getData(s);
                } catch (e) {}
            }
        }

        var sectionList = {

            'bank': ["ACB", "CTG", "MSB", "VPB"],
            'thep': ["HPG", "HSG", "NKG"],
            'banle': ["DGW", "MWG", "FPT"]
        }
        let storage = {};


        async function checkSection(nameSection = 'bank') {
            mainData = {};
            loading();
            if (!storage[nameSection]) {
                var list = (sectionList[nameSection] || ["SSI", "HSG"]).concat(["VN-INDEX"]);
                await fetchSequentiallyData(list);
                localStorage.setItem("sshs", JSON.stringify(mainData));
                storage[nameSection] = mainData;
            } else {
                localStorage.setItem("sshs", JSON.stringify(storage[nameSection]));
            }


            const popup = document.getElementById('load');
            popup.innerHTML = `<div class="popup show" style="display:block;">Biểu đồ phân tán hiệu suất<span class="popup-close">&times;</span>
				<iframe src="sshs.html" style="border: none;" width="620" height="460"></iframe></div>`;
            overlay.style.display = "block";

        }
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('popup-close')) {
                document.getElementById('load').innerHTML = '';
                overlay.style.display = "none";

            }
        });
    </script>
</body>

</html>