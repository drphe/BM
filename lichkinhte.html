<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch kinh tế</title>
    <!-- Tailwind CSS CDN -->
    <script src="tailwindcss.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Custom styles for the switch */
        .toggle-switch-container {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch-container input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #3b82f6;
            /* bg-blue-500 */
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Flatpickr styling */
        .flatpickr-calendar {
            z-index: 9999;
            top: 84px !important;
            left: 15% !important;
        }

        /* Custom table styling */
        .custom-table th,
        .custom-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .custom-table th {
            background-color: #f9fafb;
            color: #374151;
            font-weight: 600;
        }

        .custom-table tr:hover {
            background-color: #f3f4f6;
        }

        /* New loading overlay styles */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(2px);
            z-index: 10;
        }

        .image_inner {
            display: inline;
            width: 30px;
        }

        .hidden {
            display: none;
        }

        tr:nth-child(odd) {
            background: rgba(242, 242, 247, 1);
        }

        .important {
            color: #ef4444;
        }

        .positive {
            background: rgb(227 243 248);
            color: rgb(49 186 190);
        }

        .normal {
            background: rgb(248 240 229);
            color: rgb(237 173 63);
        }

        .negative {
            background: rgb(248 240 229);
            color: rgb(237 173 63);
        }

        .unrelease {
            font-weight: 500;
            background: rgb(237 196 125);
            color: rgb(250 246 246);
        }

        span {
            display: inline-flex;
            align-items: center;
            padding: 0 10px;
            border-radius: 10px;
        }
    </style>
    <!-- Flatpickr CSS & JS CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-4xl">
        <!-- Header Controls -->
        <div class="flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
            <!-- Calendar Button -->
            <button id="date-picker-btn" class="flex items-center space-x-2 px-4 py-2 bg-blue-500 text-white rounded-xl shadow hover:bg-blue-600 transition-colors duration-200 w-full sm:w-auto">
                <!-- Calendar Icon from Heroicons via SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                </svg>
                <span id="today-date-display">25 Tháng 10, 2023</span>
            </button>

            <!-- Today Button -->
            <button id="today-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-xl shadow hover:bg-gray-300 transition-colors duration-200 w-full sm:w-auto">
                Hôm nay
            </button>

            <!-- Important News Switch -->
            <div class="flex items-center space-x-3 w-full sm:w-auto">
                <span class="text-gray-700">Chỉ tin quan trọng</span>
                <label class="toggle-switch-container">
                    <input type="checkbox" id="important-news-switch">
                    <span class="slider shadow"></span>
                </label>
            </div>
        </div>

        <!-- Hidden input for Flatpickr -->
        <input type="text" id="flatpickr-input" class="hidden">

        <!-- Corporate Events Table Container -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Sự kiện</h2>
            <div id="corporate-results-container" class="relative min-h-[100px]">
                <div id="corporate-table-wrapper">
                    <!-- Table will be rendered here by JavaScript -->
                </div>
                <!-- Loading overlay -->
                <div id="corporate-loading-overlay" class="loading-overlay hidden">
                    <div class="flex flex-col items-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div>
                        <p class="mt-4 text-gray-700">Đang tải dữ liệu...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Economic Events Table Container -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Lịch Kinh tế</h2>
            <div id="economic-results-container" class="relative min-h-[100px]">
                <div id="economic-table-wrapper">
                    <!-- Table will be rendered here by JavaScript -->
                </div>
                <!-- Loading overlay -->
                <div id="economic-loading-overlay" class="loading-overlay hidden">
                    <div class="flex flex-col items-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500"></div>
                        <p class="mt-4 text-gray-700">Đang tải dữ liệu...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get references to elements
            const datePickerBtn = document.getElementById('date-picker-btn');
            const todayDateDisplay = document.getElementById('today-date-display');
            const todayBtn = document.getElementById('today-btn');
            const importantNewsSwitch = document.getElementById('important-news-switch');
            const flatpickrInput = document.getElementById('flatpickr-input');

            const corporateTableWrapper = document.getElementById('corporate-table-wrapper');
            const corporateLoadingOverlay = document.getElementById('corporate-loading-overlay');

            const economicTableWrapper = document.getElementById('economic-table-wrapper');
            const economicLoadingOverlay = document.getElementById('economic-loading-overlay');

            // --- Global variables to store fetched data ---
            let corporateEvents = [];
            let economicEvents = [];

            // --- Helper function to render the corporate table ---
            function renderCorporateTable(data) {
                corporateTableWrapper.innerHTML = '';
                if (data.length === 0) {
                    corporateTableWrapper.innerHTML = '<p class="text-center text-gray-500">Không có sự kiện quan trọng nào trong ngày này.</p>';
                    return;
                }

                let tableHTML = `
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table class="min-w-full custom-table bg-white">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6">Thời gian</th>
                                    <th class="py-3 px-6">Tiền tệ</th>
                                    <th class="py-3 px-6">Sự kiện</th>
                                    <th class="py-3 px-6">Quan trọng</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.forEach(event => {
                    const eventTime = new Date(event.event_time);
                    const formattedTime = eventTime.toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const currency = event.area_code || '';
                    const eventContent = event.event_content || '';
                    const importance = event.star || 0;
                    const starString = '⭐'.repeat(importance);

                    tableHTML += `
                        <tr>
                            <td class="py-4 px-6">${formattedTime}</td>
                            <td class="py-4 px-6 "><img src="https://mktnews.net/imgs/E_FLAG/${event.area_code}.png" loading="lazy" class="image_inner">${currency}</td>
                            <td class="py-4 px-6 important">${eventContent}</td>
                            <td class="py-4 px-6">${starString}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                corporateTableWrapper.innerHTML = tableHTML;
            }

            function formatCompactNumber(num, decnum, unit) {
                // Thử chuyển đổi giá trị đầu vào thành một số.
                const numberValue = parseFloat(num);

                // Kiểm tra nếu giá trị đã chuyển đổi không phải là số hợp lệ hoặc không hữu hạn, thì trả về một chuỗi rỗng.
                if (isNaN(numberValue) || !isFinite(numberValue)) {
                    return '--';
                }

                // Tạo một đối tượng định dạng số mới.
                const formatter = new Intl.NumberFormat('en-US', {
                    notation: 'compact', // Sử dụng ký hiệu rút gọn (ví dụ: 1M, 1K).
                    compactDisplay: 'short', // Hiển thị dưới dạng ngắn.
                    maximumFractionDigits: decnum // Số chữ số thập phân tối đa.
                });

                // Định dạng số.
                let value = formatter.format(numberValue);

                // Thêm đơn vị nếu có.
                if (unit === '%') {
                    return value + '%';
                } else {
                    return value;
                }
            }

            function getTrendIcon(trendStatus) {
                // Biểu tượng SVG cho mũi tên lên (tích cực)
                const upArrowIcon = `<span class="positive"><svg data-v-9403c75a="" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" w:m="r-2px" w:p="2px" w:w="24px" w:h="24px" w:flex="shrink-0" width="1em" height="1em" viewBox="0 0 24 24" class="iconify iconify--lucide"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M16 7h6v6"></path><path d="m22 7l-8.5 8.5l-5-5L2 17"></path></g></svg>`;

                // Biểu tượng SVG cho mũi tên xuống (tiêu cực)
                const downArrowIcon = `<span class="negative"><svg data-v-9403c75a="" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" w:m="r-2px" w:p="2px" w:w="24px" w:h="24px" w:flex="shrink-0" width="1em" height="1em" viewBox="0 0 24 24" class="iconify iconify--lucide"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M16 17h6v-6"></path><path d="m22 17l-8.5-8.5l-5 5L2 7"></path></g></svg>`;

                // Biểu tượng SVG cho trạng thái không đáng kể
                const negligibleIcon = `<span class="normal"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-gray-500 inline-block align-middle"><line x1="5" y1="12" x2="19" y2="12"></line></svg></span>`;

                // Biểu tượng SVG cho trạng thái chưa công bố
                const unreleasedIcon = `<span class="unrelease"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-gray-400 inline-block align-middle"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></span>`;

                // Chuyển đổi đầu vào thành chữ in hoa để xử lý không phân biệt chữ hoa/thường
                switch (trendStatus.toUpperCase()) {
                    case 'POSITIVE':
                        return upArrowIcon + ' GOLD</span>';
                    case 'NEGATIVE':
                        return downArrowIcon + ' GOLD</span>';
                    case 'NEGLIGIBLE':
                        return negligibleIcon;
                    case 'UNRELEASED':
                        return unreleasedIcon;
                    default:
                        return ''; // Trả về chuỗi rỗng cho trạng thái không hợp lệ
                }
            }
            // --- Helper function to render the economic table ---
            function renderEconomicTable(data) {
                economicTableWrapper.innerHTML = '';
                if (data.length === 0) {
                    economicTableWrapper.innerHTML = '<p class="text-center text-gray-500">Không có sự kiện kinh tế nào trong ngày này.</p>';
                    return;
                }

                let tableHTML = `
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table class="min-w-full custom-table bg-white">
                            <thead>
                                <tr>
                                    <th class="py-3 px-6">Thời gian</th>
                                    <th class="py-3 px-6">Tiền tệ</th>
                                    <th class="py-3 px-6">Dữ liệu</th>
                                    <th class="py-3 px-6">Quan trọng</th>
                                    <th class="py-3 px-6">Thực tế</th>
                                    <th class="py-3 px-6">Dự báo</th>
                                    <th class="py-3 px-6">Trước đó</th>
                                    <th class="py-3 px-6">Tác động</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                let lastTime = '';
                data.forEach(event => {
                    const eventTime = new Date(event.pub_time);
                    let formattedTime = eventTime.toLocaleTimeString('vi-VN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const currency = event.currency_code || '';
                    const name = event.title || '';
                    const importance = event.star || 0;
                    const starString = '⭐'.repeat(importance);
                    const actual = event.actual !== null ? event.actual : '-';
                    const consensus = event.consensus !== null ? event.consensus : '-';
                    const previous = event.previous !== null ? event.previous : '-';
                    const affectStatus = event.affect_status || '-';
                    if (formattedTime != lastTime) {
                        lastTime = formattedTime;
                    } else {
                        formattedTime = '';
                    }

                    tableHTML += `
                        <tr>
                            <td class="py-4 px-6">${formattedTime}</td>
                            <td class="py-4 px-6"><img src="https://mktnews.net/imgs/E_FLAG/${event.country_code}.png" loading="lazy" class="image_inner">${currency}</td>
                            <td class="py-4 px-6 ${event.star >= 3 ? 'important':''}">${name}</td>
                            <td class="py-4 px-6">${starString}</td>
                            <td class="py-4 px-6">${formatCompactNumber(actual, event.num_decimal, event.unit)}</td>
                            <td class="py-4 px-6">${formatCompactNumber(consensus, event.num_decimal, event.unit)}</td>
                            <td class="py-4 px-6">${formatCompactNumber(previous, event.num_decimal, event.unit)}</td>
                            <td class="py-4 px-6" style="text-align: center;">${getTrendIcon(affectStatus)}</td>
                        </tr>
                    `;
                });

                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;

                economicTableWrapper.innerHTML = tableHTML;
            }

            // --- Function to filter and render data based on the switch state ---
            function filterAndRenderTables(date) {
                const onlyImportant = importantNewsSwitch.checked;

                // Filter corporate events
                let filteredCorporate = onlyImportant ? corporateEvents.filter(event => event.star >= 2) : corporateEvents;
                renderCorporateTable(filteredCorporate);
                console.log(date)

                // Filter economic events
                let filteredEconomic = onlyImportant ? economicEvents.filter(event => event.star >= 3) : economicEvents;
                renderEconomicTable(filteredEconomic);
            }

            // --- Function to fetch corporate data ---
            async function fetchCorporateData(date) {
                corporateLoadingOverlay.classList.remove('hidden');
                const apiDate = date.toISOString();
                const apiUrl = `https://api.mktnews.net/api/event?date=${apiDate}&category=corp`;

                try {
                    const response = await fetch(apiUrl);
                    const result = await response.json();

                    if (result.status === 200 && result.data) {
                        corporateEvents = result.data; // Store fetched data
                    } else {
                        corporateEvents = [];
                        corporateTableWrapper.innerHTML = '<p class="text-center text-red-500">Lỗi khi tải dữ liệu từ API sự kiện doanh nghiệp.</p>';
                    }
                } catch (error) {
                    console.error('Fetch corporate data error:', error);
                    corporateEvents = [];
                    corporateTableWrapper.innerHTML = '<p class="text-center text-red-500">Đã xảy ra lỗi. Vui lòng thử lại sau.</p>';
                } finally {
                    corporateLoadingOverlay.classList.add('hidden');
                    filterAndRenderTables(date);
                }
            }

            // --- New function to fetch economic data ---
            async function fetchEconomicData(date) {
                economicLoadingOverlay.classList.remove('hidden');

                const apiDate = date.toISOString(); // API này yêu cầu định dạng ISO string
                const apiUrl = `https://api.mktnews.net/api/economic?date=${apiDate}`;

                try {
                    const response = await fetch(apiUrl);
                    const result = await response.json();

                    if (result.status === 200 && result.data) {
                        economicEvents = result.data; // Store fetched data
                    } else {
                        economicEvents = [];
                        economicTableWrapper.innerHTML = '<p class="text-center text-red-500">Lỗi khi tải dữ liệu từ API sự kiện kinh tế.</p>';
                    }
                } catch (error) {
                    console.error('Fetch economic data error:', error);
                    economicEvents = [];
                    economicTableWrapper.innerHTML = '<p class="text-center text-red-500">Đã xảy ra lỗi. Vui lòng thử lại sau.</p>';
                } finally {
                    economicLoadingOverlay.classList.add('hidden');
                    filterAndRenderTables(date);
                }
            }

            // --- Main function to call both data fetching functions ---
            async function updateAllData(date) {
                const resetDate = new Date(date);
                resetDate.setHours(0, 0, 0, 0);
                const adjustedDate = new Date(resetDate.getTime() - 7 * 60 * 60);
                fetchCorporateData(adjustedDate);
                fetchEconomicData(adjustedDate);
            }

            // Initialize Flatpickr
            const fp = flatpickr(flatpickrInput, {
                locale: 'vn',
                dateFormat: "j F, Y",
                defaultDate: new Date(),
                disableMobile: true,
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        const newDate = selectedDates[0];
                        todayDateDisplay.textContent = instance.formatDate(newDate, "j F, Y");
                        updateAllData(newDate);
                    }
                }
            });

            // Set initial date display to today
            const today = new Date();
            todayDateDisplay.textContent = fp.formatDate(today, "j F, Y");
            updateAllData(today);

            // Event listener for the main date button
            datePickerBtn.addEventListener('click', () => {
                fp.open();
            });

            // Event listener for the "Hôm nay" button
            todayBtn.addEventListener('click', () => {
                const today = new Date();
                fp.setDate(today, true);
                todayDateDisplay.textContent = fp.formatDate(today, "j F, Y");
                updateAllData(today);
            });

            // Event listener for the switch
            importantNewsSwitch.addEventListener('change', () => {
                filterAndRenderTables();
            });
        });
    </script>
</body>

</html>